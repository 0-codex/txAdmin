{{@include("header", it)/}}

<!-- Page CSS -->
<link rel="stylesheet" href="css/codemirror.css">
<link rel="stylesheet" href="css/codemirror_lucario.css">
<style>
    .cm-s-lucario{
        font-size: 1.05rem !important;
    }
    .CodeMirror{
        height: auto;
    }
    .deployer-stepper > .card-header,
    .deployer-stepper > .card-footer{
        font-size: large;
    }
</style>


<div class="row justify-content-md-center">
    <div class="col-md-7 mw-col8">

        <!-- Global Card -->
        <div class="card card-accent-primary deployer-stepper">
            {{@if(it.step == 'review')}}
                <div class="card-header font-weight-bold">Step 1: Review Recipe</div>
                <div class="card-body">
                    <div class="row mb-1 mt-0 text-center">
                        <div class="col-8 mx-auto card d-block border-primary p-2 mb-1">
                            Please review the Recipe below and apply any changes you want, <br>
                            then press the <strong>Run Recipe</strong> button below.

                            {{@if(!it.recipe.editorsChoice)}}
                                <br><span class="text-danger font-weight-bold">Warning: Only run Recipes from trusted sources!</span>
                            {{/if}}
                        </div>
                    </div>
                    <p class="mb-1">
                        <strong style="word-wrap: break-word;">{{it.recipe.name}}</strong>
                        {{@if(it.recipe.version != '')}}
                            <em>{{it.recipe.version}}</em>
                        {{/if}}
                        {{@if(it.recipe.author != '')}}
                            by {{it.recipe.author}}
                        {{/if}}
                        {{@if(it.recipe.description != '')}}
                            <br>
                            {{it.recipe.description}}
                        {{/if}}
                    </p>

                    <textarea id="codeMirrorTarget" style="width: 100%;" class="cms-s-lucario" name="code">{{it.recipe.raw}}</textarea>
                    <div class="row justify-content-center m-2">
                        <button class="btn btn btn-outline-danger" type="button" onclick="cancelAction()">Cancel and Return to Setup</button>
                        &nbsp; &nbsp;
                        <button type="button" onclick="step1Action();" class="btn btn-success">Run Recipe</button>
                    </div>
                </div>
                <div class="card-footer text-muted">Step 2: Run Recipe</div>
                <div class="card-footer text-muted">Step 3: Configure server.cfg</div>

            {{#elif(it.step == 'run')}}
                <div class="card-header">Step 1: Review Recipe ‚úîÔ∏è</div>
                <div class="card-header font-weight-bold ">Step 2: Run Recipe</div>
                <div class="card-body text-center">
                    <div class="row mb-1 mt-0 text-center">
                        <div class="col-8 mx-auto card d-block border-primary p-2 mb-1">
                            Your recipe is being executed, the data will be deployed to: <br>
                            <code>{{it.deployPath}}</code>
                        </div>
                    </div>
                    <code>
                        Starting deployment... <br>
                        Cloning repository: https://github.com/citizenfx/cfx-server-data.git
                    </code>

                    <div class="mx-auto col-8 pt-3">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 75%">75%</div>
                        </div>
                    </div>
                </div>
                <div class="card-footer text-muted">Step 3: Configure server.cfg</div>

            {{#elif(it.step == 'configure')}}
                <div class="card-header">Step 1: Review Recipe ‚úîÔ∏è</div>
                <div class="card-header">Step 2: Run Recipe ‚úîÔ∏è</div>
                <div class="card-header font-weight-bold">Step 3: Configure server.cfg</div>
                <div class="card-body">
                    <div class="row mb-1 mt-0 text-center">
                        <div class="col-8 mx-auto card d-block border-primary p-2 mb-1">
                            Configure your <code>server.cfg</code> file to your liking, <br>
                            then press the <strong>Save & Run Server</strong> button below.
                        </div>
                    </div>

                    <textarea id="codeMirrorTarget" style="width: 100%;" class="cms-s-lucario" name="code">{{it.serverCFG}}</textarea>
                    <div class="row justify-content-center m-2">
                        <button class="btn btn btn-outline-danger" type="button" onclick="cancelAction()">Cancel and Return to Setup</button>
                        &nbsp; &nbsp;
                        <button type="button" onclick="step1Action();" class="btn btn-success">Save & Run Server</button>
                    </div>
                </div>

            {{#else}}
                <div class="card-body text-center">
                    Somethign is wrong ü§î
                </div>
            {{/if}}
        </div>

    </div>
</div>


{{@include("footer", it)/}}


<script src="js/codeEditor/codemirror.js"></script>
<script src="js/codeEditor/mode/simple.js"></script>
<script src="js/codeEditor/mode/fivem-cfg.js"></script>
<script src="js/codeEditor/mode/yaml.js"></script>
<script>
    //============================================== CodeMirror Setup
    window.onload = function () {
        const codeMirrorTarget = document.getElementById("codeMirrorTarget");
        window.editor_markdown = CodeMirror.fromTextArea(codeMirrorTarget, {
            mode: ('{{it.step}}' == 'review')? 'yaml' : 'fivem-cfg',
            lineNumbers: true,
            lineWrapping: true,
            viewportMargin: Infinity,
            theme: "lucario" //NOTE: I modified the theme a bit
        });
    };


    //============================================== Step1 action
    function step1Action(){
        return alert('TODO 1');
    }

    //============================================== Step2 action
    function step2Action(){
        return alert('TODO 2');
    }

    //============================================== Step3 action
    function step3Action(){
        return alert('TODO 3');
    }

    //============================================== cancel action
    function cancelAction(){
        return alert('TODO cancel');

        /*
            TODO:
            Call an endpoint to reset fxRunner settings, then redirect back to /setup
        */

        $.ajax({
            type: "POST",
            url: '/player/ban',
            timeout: timeoutLong,
            data,
            dataType: 'json',
            success: function (data) {
                if(data.refresh === true){
                    window.location.reload(true);
                }else{
                    notify.update('progress', 0);
                    notify.update('type', data.type);
                    notify.update('message', data.message);
                }
            },
            error: function (xmlhttprequest, textstatus, message) {
                notify.update('progress', 0);
                notify.update('type', 'danger');
                notify.update('message', message);
            }
        });
    }




</script>
