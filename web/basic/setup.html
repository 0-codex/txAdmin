<!DOCTYPE html>
<html lang="en">

<head>
    <base href="/">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <meta name="description" content="txAdmin - remotely Manage & Monitor your GTA5 FiveM Server">
    <meta name="author" content="Andr√© Tabarra">
    <title>{{it.headerTitle}}</title>
    <link href="css/simple-line-icons.css" rel="stylesheet">
    <link href="css/coreui.min.css" rel="stylesheet">
    <link rel="shortcut icon" type="image/png" href="img/favicon_default.png" id="favicon" />
    <link rel="stylesheet" href="css/txAdmin.css">

    <!-- Page CSS -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://unpkg.com/materialize-stepper@3.1.0/dist/css/mstepper.min.css">

    <style>
        code{
            color: #321fdb!important;
        }
        .bigbutton{
            cursor: pointer;
            background-color: #f7f7f7;
            -webkit-transition: background-color 250ms linear, color 50ms linear;
            -ms-transition: background-color 250ms linear, color 50ms linear;
            transition: background-color 250ms linear, color 50ms linear;
        }
        .bigbutton:hover{
            background-color: #2196f3 !important;
            color: white; 
        }
        .stepper{
            list-style: none;
            padding-inline-start: 20px;
        }
        .deployment-type-card{
            border-radius: 15px;
            margin: 0.75em;
        }
        .deployment-type-card > .card-body{
            padding: 0.75rem !important;
        }
        .template-cards{
            margin: 5px;
            padding: 8px;
            height: 5.1rem;
            border-radius: 5px;
        }
        .template-cards > span{
            overflow: hidden;
            word-wrap: break-word;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-box-orient: vertical;
        }
        .template-cards > .title{
            -webkit-line-clamp: 1;
        }
        .template-cards > .description{
            -webkit-line-clamp: 2;
        }
        .template-cards > .title::before{
            content: "‚≠ê";
        }
    </style>
</head>

<body class="c-app flex-row align-items-center">

    <div class="container">

        <!-- Logo Row -->
        <div class="row justify-content-center pt-4 mb-4">
            <img src="img/txadmin.png" alt="txAdmin Logo">
        </div>

        <!-- Stepper Row -->
        <div class="row justify-content-center">
            <div class="col-12 col-md-12 col-lg-8">
                <div class="card fade-in">
                    <div class="card-body">
                        <ul class="stepper linear">

                            <!-- Welcome -->
                            <li class="step active">
                                <div class="step-title waves-effect">Welcome, {{it.adminUsername}}!</div>
                                <div class="step-content">
                                    {{@if(it.serverProfile == 'default')}}
                                        Since you didn't select any profile when starting txAdmin, we selected
                                        <code>default</code> for you.
                                    {{#else}}
                                        You selected the profile <code>{{it.serverProfile}}</code>.
                                    {{/if}}
                                    <br>
                                    This profile is not configured yet, let's do this now?
                                    <div class="step-actions">
                                        <button class="btn btn-pill btn-info next-step" type="button">Next</button>
                                    </div>
                                </div>
                            </li>


                            <!-- Server Name -->
                            <li class="step">
                                <div class="step-title waves-effect">Server Name</div>
                                <div class="step-content">
                                    A <strong>short</strong> server name to be used in txAdmin interface and
                                    Chat/Discord messages.
                                    <input type="text" class="form-control mt-2" id="frmName" maxlength="22"
                                        minlength="3" placeholder="Happy Server" required>
                                    <span id="frmNameError" class="text-danger fade-in d-none"></span>
                                    <div class="step-actions">
                                        <button class="btn btn-pill btn-secondary previous-step"
                                            type="button">Back</button>
                                        <button class="btn btn-pill btn-info next-step" type="button"
                                            data-feedback="validateName" id="frmNameSubmitBtn">Next</button>
                                    </div>
                                </div>
                            </li>


                            <!-- Deployment Type -->
                            <li class="step">
                                <div class="step-title waves-effect">Deployment Type</div>
                                <div class="step-content">
                                    <strong>Select</strong> how you want to setup your server:
                                    <div class="card bigbutton deployment-type-card border-dark">
                                        <div class="card-body next-step" onclick="selectDeploymentType('common')">
                                            <strong>‚≠ê Editor's Choice Template</strong> <br>
                                            Select a template from a curated list of community favorites. <br>
                                            This includes ESX, vRP and a Default template for you to customize.
                                        </div>
                                    </div>
                                    <div class="card bigbutton deployment-type-card border-dark">
                                        <div class="card-body next-step" onclick="selectDeploymentType('remote')">
                                            <strong>üìë Remote URL Template</strong> <br>
                                            Based on a Recipe URL in the YAML format. <br>
                                            You will have the option to edit the Recipe before running it.
                                        </div>
                                    </div>
                                    <div class="card bigbutton deployment-type-card border-dark">
                                        <div class="card-body next-step" onclick="selectDeploymentType('local')">
                                            <strong>üìÅ Local Server Data</strong> <br>
                                            Select an existing server-data folder in the VPS. <br>
                                            This is the option you are already used to.
                                        </div>
                                    </div>
                                    <div class="step-actions">
                                        <button class="btn btn-pill btn-secondary previous-step"
                                            type="button">Back</button>
                                    </div>
                                </div>
                            </li>


                            <!-- Step 4 -->
                            <li class="step">
                                <div class="step-title waves-effect" id="s4Title"><i>please select deployment type</i></div>
                                <div class="step-content">
                                    <!-- select template buttons -->
                                    <template id="s4CommonCardTemplate">
                                        <div class="bigbutton template-cards border-dark next-step">
                                            <span class="title">
                                                <strong>CFX Default</strong> <em>(v1.0.0)</em>
                                            </span>
                                            <span class="description">
                                                Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt 
                                            </span>
                                        </div>
                                    </template>
                                    <div class="d-none" id="s4CommonDiv">
                                        <div class="row" id="s4CommonRow"></div> 
                                        
                                        <div class="step-actions">
                                            <button class="btn btn-pill btn-secondary previous-step"
                                                type="button">Back</button>
                                        </div>
                                    </div>

                                    <!-- input url with some minimal backend validation -->
                                    <div class="d-none" id="s4RemoteDiv">
                                        The URL for the remote recipe, or the forum thread. <br>
                                        You can discover new recipes by visiting the <a href="https://forum.cfx.re/c/development/releases/7" target="_blank" rel="noopener noreferrer">CFX Forum</a>.
                                        <input type="text" class="form-control mt-2" id="s4RemoteInput"
                                            placeholder="https://raw.githubusercontent.com/tabarra/PlumeESX2/master/.fxrecipe"
                                            DEBUG value="https://gist.githubusercontent.com/tabarra/f104c19f127ea27940696cfae17c714f/raw/323a65e2a1629238a38a4abf7e917f460c492846/plumeesx2.yaml">
                                        <span id="s4RemoteInputError" class="text-danger fade-in d-none"></span>
                                        <div class="step-actions">
                                            <button class="btn btn-pill btn-secondary previous-step"
                                                type="button">Back</button>
                                            <button class="btn btn-pill btn-info next-step" type="button"
                                                data-feedback="validateRemoteTemplate">Next</button>
                                        </div>
                                    </div>

                                    <!-- input local data folder -->
                                    <div class="d-none" id="s4LocalDiv">
                                        The folder that <strong>contains</strong> the <code>resources</code> and
                                        <code>cache</code> folders, usually it's here that you put your <code>server.cfg</code>. <br>
                                        Also known as Base Folder.
                                        <input type="text" class="form-control mt-2" id="s4LocalInput"
                                            placeholder="C:/Users/Admin/Desktop/server01">
                                        <span id="s4LocalInputError" class="text-danger fade-in d-none"></span>
                                        <div class="step-actions">
                                            <button class="btn btn-pill btn-secondary previous-step"
                                                type="button">Back</button>
                                            <button class="btn btn-pill btn-info next-step" type="button"
                                                data-feedback="validateDataFolder" id="s4FolderSubmitBtn">Next</button>
                                            <button class="btn btn-pill btn-primary d-none fade-in" type="button"
                                                id="s4LocalInputFixBtn" 
                                                data-target="s4LocalInput">Accept Fix</button>
                                        </div>
                                    </div>

                                </div>
                            </li>


                            <!-- Step 5 -->
                            <li class="step">
                                <div class="step-title waves-effect" id="s5Title"><i>please select deployment type</i></div>
                                <div class="step-content" id="s5Content">

                                    <!-- input local data folder --> 
                                    <div class="d-none" id="s5TemplateDiv">
                                        local data folder
                                        <div class="step-actions">
                                            <button class="btn btn-pill btn-secondary previous-step"
                                                type="button">Back</button>
                                            <button class="btn btn-pill btn-danger next-step" type="button"
                                                data-feedback="validateTrue">next remove</button>
                                        </div>
                                    </div>

                                    <!-- input server cfg file -->
                                    <div class="d-none" id="s5LocalDiv">
                                        The path to your server config file, usually named <code>server.cfg</code>. <br>
                                        This can either be absolute, or relative to the Server Data folder.
                                        <input type="text" class="form-control mt-2" id="frmCFGFile"
                                            placeholder="C:/Users/Admin/Desktop/server01/server.cfg">
                                        <span id="frmCFGFileError" class="text-danger fade-in d-none"></span>
                                        <div class="step-actions">
                                            <div class="step-actions">
                                                <button class="btn btn-pill btn-secondary previous-step"
                                                    type="button">Back</button>
                                                <button class="btn btn-pill btn-info next-step" type="button"
                                                    data-feedback="validateCFGFile" id="frmCFGFileSubmitBtn">Save</button>
                                                <button class="btn btn-pill btn-primary d-none fade-in" type="button"
                                                    id="frmCFGFileFixBtn" 
                                                    data-target="frmCFGFile">Accept Fix</button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                </div>
                            </li>


                            <!-- Finish -->
                            <li class="step">
                                <div class="step-title waves-effect">Finish</div>
                                <div class="step-content">
                                    <strong>We are all set!</strong> <br>
                                    {{@if(it.windowsBatPath)}}
                                        You can run this profile by executing: <br>
                                        <code>{{it.windowsBatPath}}</code> <br>
                                    {{/if}}
                                    <span id="saveError" class="text-danger fade-in d-none"></span>
                                    <div class="step-actions">
                                        <button class="btn btn-pill btn-success next-step" 
                                            type="button" data-feedback="performSave">
                                            Save & Start Server</button>
                                    </div>
                                </div>
                            </li>

                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Info Row -->
        <div class="row justify-content-center">
            <div class="col-md-4 ">
                <div class="alert alert-secondary text-center small" role="alert">
                    <strong>Server profile:</strong> {{it.serverProfile}} <br>
                    <strong>txAdmin version:</strong> {{it.txAdminVersion}} <br>
                    <strong>FXServer build:</strong> {{it.fxServerVersion}} 
                    <div class="hrsep hrsep-small">//</div>
                    <h5 class="text-muted">
                        <strong>txAdmin</strong> Official Discord: <br>
                        <a href="https://discord.gg/uAmsGa2" target="_blank">
                            <img src="https://discordapp.com/api/guilds/577993482761928734/widget.png?style=shield"></img>
                        </a>
                    </h5>
                </div>
            </div>
        </div>


    </div>
    <!-- CoreUI and necessary plugins-->
    <script src="js/jquery.min.js"></script>
    <script src="js/coreui.bundle.min.js"></script>
    <script src="js/bootstrap-notify.min.js"></script>

    <!-- JS -->
    <script src="https://unpkg.com/materialize-stepper@3.1.0/dist/js/mstepper.js"></script>
    <script>
        //Constants & vars
        const timeoutLong = 5000;
        const spinnerHTML = '<div class="txSpinner">Loading...</div>';
        const suggestions = {};
        let selectedDeploymentType;
        let selectedTemplateURL;

        //Stepper config
        const stepper = document.querySelector('.stepper');
        const stepperInstace = new MStepper(stepper, {
            autoFocusInput: true,
            showFeedbackPreloader: true,
            stepTitleNavigation: false,
            firstActive: 0,
            feedbackPreloader: spinnerHTML,
        });

        //Functions
        const checkDoLogout = (data) => {
            if(typeof data.logout !== 'undefined'){
                window.location = '/auth?logout';
                return true;
            }
            return false;
        }
        const inputKeyUp = (event) => {
            event.target.classList.remove('is-invalid', 'is-valid');
            if (event.keyCode === 13) {
                event.preventDefault();
                document.getElementById(event.target.id+'SubmitBtn').click();
            }
        }
        const acceptFix = (event) => {
            event.target.classList.add('d-none');
            const targetName = event.target.dataset.target;
            const targetElement = document.getElementById(targetName);
            targetElement.classList.remove('is-invalid');
            targetElement.classList.add('is-valid');
            targetElement.value = suggestions[targetName] || '';
            const currentSteps = stepperInstace.getSteps();
            currentSteps.active.step.classList.remove('wrong');
            currentSteps.active.step.classList.add('done');
        }


        //Grabs the elements and set the event handlers
        const frmName = document.getElementById("frmName");
        const frmNameError = document.getElementById("frmNameError");
        frmName.addEventListener("keyup", inputKeyUp);

        //Step 4
        const s4Title = document.getElementById("s4Title");
        const s4CommonDiv = document.getElementById("s4CommonDiv");
        const s4CommonCardTemplate = document.getElementById("s4CommonCardTemplate");
        const s4CommonRow = document.getElementById("s4CommonRow");
        const s4RemoteDiv = document.getElementById("s4RemoteDiv");
        const s4LocalDiv = document.getElementById("s4LocalDiv");
        const s4RemoteInput = document.getElementById("s4RemoteInput");
        const s4RemoteInputError = document.getElementById("s4RemoteInputError");
        s4RemoteInput.addEventListener("keyup", inputKeyUp);
        const s4LocalInput = document.getElementById("s4LocalInput");
        const s4LocalInputError = document.getElementById("s4LocalInputError");
        const s4LocalInputFixBtn = document.getElementById("s4LocalInputFixBtn");
        s4LocalInput.addEventListener("keyup", inputKeyUp);
        s4LocalInputFixBtn.addEventListener("click", acceptFix);


        const s5Title = document.getElementById("s5Title");
        const s5Content = document.getElementById("s5Content");
        const s5TemplateDiv = document.getElementById("s5TemplateDiv");
        const s5LocalDiv = document.getElementById("s5LocalDiv");
        
        const frmCFGFile = document.getElementById("frmCFGFile");
        const frmCFGFileError = document.getElementById("frmCFGFileError");
        const frmCFGFileFixBtn = document.getElementById("frmCFGFileFixBtn");
        frmCFGFile.addEventListener("keyup", inputKeyUp);
        frmCFGFileFixBtn.addEventListener("click", acceptFix);
        
        
        // Server Name step validation
        function validateName(destroyFeedback) {
            frmName.classList.remove('is-invalid', 'is-valid');
            frmNameError.classList.add('d-none');
            const name = frmName.value.trim();

            if(name.length < 3 || name.length > 22){
                frmNameError.innerHTML = `The name must have between 3 and 22 characters.`;
                frmNameError.classList.remove('d-none');
                frmName.classList.add('is-invalid');
                stepperInstace.wrongStep();
                destroyFeedback(false)
            }else{
                frmName.classList.add('is-valid');
                destroyFeedback(true)
            }
        }

        // Deployment type selection
        function selectDeploymentType(depType){
            selectedDeploymentType = depType;
            selectedTemplateURL = null;
            if(depType == 'common'){
                s4Title.textContent = "Select Template";
                s5Title.textContent = "Data Location";
                s4CommonRow.innerHTML = spinnerHTML;
                s4CommonDiv.classList.remove('d-none');
                s4RemoteDiv.classList.add('d-none');
                s4LocalDiv.classList.add('d-none');
                s5TemplateDiv.classList.remove('d-none');
                s5LocalDiv.classList.add('d-none');
                setFavTemplatesCards();
                
            }else if(depType == 'remote'){
                s4Title.textContent = "Import Remote Template";
                s5Title.textContent = "Data Location";
                s4CommonDiv.classList.add('d-none');
                s4RemoteDiv.classList.remove('d-none');
                s4LocalDiv.classList.add('d-none');
                s5TemplateDiv.classList.remove('d-none');
                s5LocalDiv.classList.add('d-none');
                
            }else if(depType == 'local'){
                s4Title.textContent = "Local Server Data";
                s5Title.textContent = "Server CFG File";
                s4CommonDiv.classList.add('d-none');
                s4RemoteDiv.classList.add('d-none');
                s4LocalDiv.classList.remove('d-none');
                s5TemplateDiv.classList.add('d-none');
                s5LocalDiv.classList.remove('d-none');
            }
        }

        //Download Recipe Editors Choice list and create cards
        async function setFavTemplatesCards(){
            //NOTE: mocked
            const tmpGETResponse = [
                {
                    name: 'CFX Default',
                    version: '1.0.0',
                    description: 'Official recipe for the base resources required to run a server.',
                    url: 'def'
                },
                {
                    name: 'PlumeESX2',
                    version: '1.2.3',
                    description: 'A full featured (8 jobs) and highly configurable yet lightweight ESX v2 base that can be easily extendable.',
                    url: 'plume'
                },
                {
                    name: 'Testing',
                    description: 'Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ',
                    url: 'test'
                }
            ];
            
            setTimeout(() => {
                s4CommonRow.innerHTML = '';
                tmpGETResponse.forEach(recipe => {
                    const newNode = document.createElement("div");
                    newNode.innerHTML = s4CommonCardTemplate.innerHTML;
                    newNode.classList.add('col-12', 'col-md-6', 'p-0');
                    newNode.querySelector('.bigbutton').onclick = () => {selectTemplate(recipe.url)};
                    newNode.querySelector('.title > strong').innerText = recipe.name;
                    newNode.querySelector('.title > em').innerText = (recipe.version)? `${recipe.version}` : '';
                    newNode.querySelector('.description').innerText = recipe.description;

                    s4CommonRow.appendChild(newNode);
                });
            }, 250);
        }

        // Deployment type selection
        function selectTemplate(template){
            selectedTemplateURL = template;
            stepperInstace.nextStep();
        }

        // Server Name step validation
        function validateRemoteTemplate(destroyFeedback) {
            const currentSteps = stepperInstace.getSteps();
            s4RemoteInput.classList.remove('is-invalid', 'is-valid');
            s4RemoteInputError.classList.add('d-none');

            $.ajax({
                type: "POST",
                url: '/setup/validateRecipeURL',
                timeout: timeoutLong,
                data: {recipeURL: s4RemoteInput.value.trim()},
                dataType: 'json',
                success: function (data) {
                    if(checkDoLogout(data)) return;
                    if (data.success == true){
                        currentSteps.active.step.classList.remove('wrong');
                        currentSteps.active.step.classList.add('done');
                        s4RemoteInput.classList.add('is-valid');
                        destroyFeedback(true);
                    }else{
                        stepperInstace.wrongStep();
                        s4RemoteInputError.innerHTML = `<br>Error:</b> ${data.message} <br>Make sure this is a valid Recipe URL.`;
                        s4RemoteInputError.classList.remove('d-none');
                        s4RemoteInput.classList.add('is-invalid');
                        destroyFeedback(false);
                    }
                },
                error: function (xmlhttprequest, textstatus, message) {
                    stepperInstace.wrongStep();
                    s4RemoteInputError.innerHTML = `<br>Error:</b> ${message} <br>Make sure this is a valid Recipe URL.`;
                    s4RemoteInputError.classList.remove('d-none');
                    s4RemoteInput.classList.add('is-invalid');
                    destroyFeedback(false);
                }
            });
        }

        //DEBUG
        function validateTrue(destroyFeedback){
            destroyFeedback(true)
        }

        // Server Data Folder step validation
        function validateDataFolder(destroyFeedback) {
            const currentSteps = stepperInstace.getSteps();
            s4LocalInput.classList.remove('is-invalid', 'is-valid');
            s4LocalInputError.classList.add('d-none');
            
            $.ajax({
                type: "POST",
                url: '/setup/validateDataFolder',
                timeout: timeoutLong,
                data: {dataFolder: s4LocalInput.value.trim()},
                dataType: 'json',
                success: function (data) {
                    if(checkDoLogout(data)) return;
                    if (data.success == true){
                        currentSteps.active.step.classList.remove('wrong');
                        currentSteps.active.step.classList.add('done');
                        frmName.classList.add('is-valid');
                        destroyFeedback(true)
                    }else{
                        s4LocalInputError.innerHTML = data.message;
                        s4LocalInputError.classList.remove('d-none');
                        s4LocalInput.classList.add('is-invalid');
                        stepperInstace.wrongStep();
                        if(data.suggestion){
                            suggestions['s4LocalInput'] = data.suggestion;
                            s4LocalInputFixBtn.classList.remove('d-none');
                        }
                        destroyFeedback(false)
                    }
                },
                error: function (xmlhttprequest, textstatus, message) {
                    s4LocalInputError.innerHTML = `<br>Error:</b> ${message} <br>Please try again.`;
                    s4LocalInputError.classList.remove('d-none');
                    destroyFeedback(false)
                }
            });

        }

        // Server CFG File step validation
        function validateCFGFile(destroyFeedback) {
            const currentSteps = stepperInstace.getSteps();
            frmCFGFile.classList.remove('is-invalid', 'is-valid');
            frmCFGFileError.classList.add('d-none');
            const outData = {
                dataFolder: s4LocalInput.value.trim(),
                cfgFile: frmCFGFile.value.trim(),
            };
            
            $.ajax({
                type: "POST",
                url: '/setup/validateCFGFile',
                timeout: timeoutLong,
                data: outData,
                dataType: 'json',
                success: function (data) {
                    if(checkDoLogout(data)) return;
                    if (data.success == true){
                        currentSteps.active.step.classList.remove('wrong');
                        currentSteps.active.step.classList.add('done');
                        frmName.classList.add('is-valid');
                        destroyFeedback(true)
                    }else{
                        frmCFGFileError.innerHTML = data.message;
                        frmCFGFileError.classList.remove('d-none');
                        frmCFGFile.classList.add('is-invalid');
                        stepperInstace.wrongStep();
                        if(data.suggestion){
                            suggestions['frmCFGFile'] = data.suggestion;
                            frmCFGFileFixBtn.classList.remove('d-none');
                        }
                        destroyFeedback(false)
                    }
                },
                error: function (xmlhttprequest, textstatus, message) {
                    frmCFGFileError.innerHTML = `<br>Error:</b> ${message} <br>Please try again.`;
                    frmCFGFileError.classList.remove('d-none');
                    destroyFeedback(false)
                }
            });
        }

        // Save function
        function performSave(destroyFeedback) {
            const saveError = document.getElementById("saveError");
            saveError.classList.add('d-none');
            const outData = {
                name: frmName.value.trim(),
                template: false,
                dataFolder: s4LocalInput.value.trim(),
                cfgFile: frmCFGFile.value.trim(),
            };
            
            $.ajax({
                type: "POST",
                url: '/setup/save',
                timeout: timeoutLong,
                data: outData,
                dataType: 'json',
                success: function (data) {
                    if(checkDoLogout(data)) return;
                    if (data.success == true){
                        window.location = '/console';
                    }else{
                        saveError.innerHTML = data.message;
                        saveError.classList.remove('d-none');
                        stepperInstace.wrongStep();
                        destroyFeedback(false)
                    }
                },
                error: function (xmlhttprequest, textstatus, message) {
                    saveError.innerHTML = `<br>Error:</b> ${message} <br>Please try again.`;
                    saveError.classList.remove('d-none');
                    destroyFeedback(false)
                }
            });
        }
    </script>
</body>
</html>
